---
title: "Final Project Analysis"
author: "Shelley, Steph, Lizzy, Veronica"
date: "4/15/2019"
output: pdf_document
---

```{r setup, include=FALSE}
library(plyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(childsds)

knitr::opts_chunk$set(include = FALSE, cache = TRUE)

# First, load the data
ShelleyStephLizzyVeronicaDataLoad <- function(filename) 
{
  if(Sys.info()['sysname']=="Darwin"){
    macfilepath <- paste("./NLSY Data/", filename, sep = "")
     load(as.character(macfilepath), envir = globalenv())}
  else{
    windowsfilepath <- paste("~/GitHub/finalproject/NLSY Data/", filename, sep = "")
     load(as.character(windowsfilepath), envir = globalenv())
  }
}

ShelleyStephLizzyVeronicaDataLoad("imputed_data.Rdata")
final_data <- imputed_data
rm(imputed_data)
```


##Note that the variables we've chosen are:

*Exposure*: Victim of bullying prior to age 12 (bullied_bf_12_1997)
*Outcome*: Drug use during adolescence/Young adulthood (ever_new_user)

*Ws*:
Race (KEY_RACE_ETHNICITY_1997)
Sex (KEY_SEX_1997)
Sexual Orientation (anySameSex)
BMI (BMI)
Learning Disability (learning_disability_1997)
Bio Mom's Education (CV_HGC_BIO_MOM_1997)
Citizenship (CV_CITIZENSHIP_1997)
Not Living with both Biological Parents (YOUTH_BOTHBIO.01_1997)

```{r data cleaning}
#Let's do all Variable prep/Data cleaning in this chunk

#some cleaning of variables to rename levels for ease of visualization
final_data$bullied_bf_12_1997 <- as.factor(final_data$bullied_bf_12_1997)
final_data$bullied_bf_12_1997 <- revalue(final_data$bullied_bf_12_1997,    
                                         c("0"="NotBullied", "1"="Bullied"))

final_data$ever_new_user2 <- as.factor(final_data$ever_new_user2)
final_data$ever_new_user2 <- revalue( final_data$ever_new_user2,
                                      c("0" = "NoDrugUse", "1" = "DrugUse"))

final_data$KEY_RACE_ETHNICITY_1997 <- as.factor(final_data$KEY_RACE_ETHNICITY_1997)
final_data$KEY_RACE_ETHNICITY_1997 <- revalue(final_data$KEY_RACE_ETHNICITY_1997,    
                                         c("1"="Black", "2"="Hispanic", "3"="MixedRace", "4"="White"))

#Decision was made to remove the Mixed Race group due to small numbers
final_data <- final_data %>% filter(KEY_RACE_ETHNICITY_1997 != "MixedRace")
final_data$KEY_RACE_ETHNICITY_1997 <- droplevels(final_data$KEY_RACE_ETHNICITY_1997) #takes away the empty category

final_data$KEY_SEX_1997 <- as.factor(final_data$KEY_SEX_1997)
final_data$KEY_SEX_1997 <- revalue(final_data$KEY_SEX_1997,    
                                         c("1"="M", "2"="F"))

final_data$anySameSex <- as.factor(final_data$anySameSex)
final_data$anySameSex <- revalue(final_data$anySameSex, c("FALSE" = "NoSameSex", "TRUE" = "SomeSameSex"))

final_data$learning_disability_1997 <- as.factor(final_data$learning_disability_1997)
final_data$learning_disability_1997  <- revalue(final_data$learning_disability_1997 , c("0" = "NoLearningDisability", "1" = "LearningDisability"))

final_data$CV_CITIZENSHIP_1997 <- as.factor(final_data$CV_CITIZENSHIP_1997)
final_data$CV_CITIZENSHIP_1997 <- revalue(final_data$CV_CITIZENSHIP_1997, c("1"="BornInUS", "2"="NotBornInUS", "3"="BirthplaceUnknown"))

final_data$YOUTH_BOTHBIO.01_1997 <- as.factor(final_data$YOUTH_BOTHBIO.01_1997)
final_data$YOUTH_BOTHBIO.01_1997 <- revalue(final_data$YOUTH_BOTHBIO.01_1997, c("1"="LivesWBothBioParents", "0"="DoesntLiveWBioParents"))

final_data$overweight <- as.factor(final_data$overweight)
final_data$overweight <- revalue(final_data$overweight, c("0"="NotOverweight", "1"="Overweight"))


#Categorizing the Maternal Education variable
final_data$MomEducation <- NA
final_data$MomEducation[final_data$CV_HGC_BIO_MOM_1997 < 12] <- 0
final_data$MomEducation[final_data$CV_HGC_BIO_MOM_1997 == 12] <- 1
final_data$MomEducation[final_data$CV_HGC_BIO_MOM_1997 > 12] <- 2
final_data$MomEducation <-as.factor(final_data$MomEducation)
final_data$MomEducation <- revalue(final_data$MomEducation, c("0"="LessThanHigh", "1"="HighSchlGrad", "2"="SomeCollege"))

#dichotomous version of maternal education variable
final_data$MomEduDi <- NA
final_data$MomEduDi[final_data$CV_HGC_BIO_MOM_1997 < 12] <- 1
final_data$MomEduDi[final_data$CV_HGC_BIO_MOM_1997 == 12] <- 1
final_data$MomEduDi[final_data$CV_HGC_BIO_MOM_1997 > 12] <- 2
final_data$MomEduDi <-as.factor(final_data$MomEduDi)
final_data$MomEduDi <- revalue(final_data$MomEduDi, c("1"="HighSchlOrLess", "2"="SomeCollege"))

#Using CDC growth charts (via AGD package) to get BMI Z scores by age 
final_data$Birthdate <-paste("15", as.character(final_data$KEY_BDATE_M_1997),
                             as.character(final_data$KEY_BDATE_Y_1997),sep=" ")
final_data$Birthdate <-dmy(final_data$Birthdate)
final_data$AgeIn1997 <- as.numeric((dmy("30 06 1997") - final_data$Birthdate)/365.25) #This is approximate

 final_data <-  final_data %>%
                    mutate(bmiz = sds(BMI,
                    age = AgeIn1997,
                    sex = KEY_SEX_1997, male = "M", female =  "F",
                    ref = cdc.ref,
                    item = "bmi",
                    type = "SDS"))
 
 #Note, there's one observation with a z score of -20, and some with -Inf? trying to find that
 final_data %>% ggplot(aes(y=bmiz)) +geom_boxplot() 
 HugeNegZScores <- final_data %>% filter(bmiz< -15)
 
 #if I exclude those 9 subjects, the boxplot looks like this
  final_data %>% filter(bmiz> -15) %>% ggplot(aes(y=bmiz)) +geom_boxplot() 
  
  #Overweight variable based on pediatric criteria
  final_data$PediOverweight<-"NotOverweight"
  final_data$PediOverweight[final_data$bmiz > 1.036433] <-"Overweight" #because z of 1.036433 corresponds to 85th percentile, which is the definition of overweight in kids
 final_data$PediOverweight <- as.factor(final_data$PediOverweight)
```


#Practical Positivity Assumption Assessment

```{r}


#just sexual orientaion with exp/out
table(final_data$bullied_bf_12_1997,final_data$ever_new_user2,
      final_data$anySameSex, 
      useNA="ifany")


#just learning/emotional problem with exp/out
table(final_data$bullied_bf_12_1997,final_data$ever_new_user2,
      final_data$learning_disability_1997, 
      useNA="ifany")

#just citizenship with exp/out
table(final_data$bullied_bf_12_1997,final_data$ever_new_user2,
      final_data$CV_CITIZENSHIP_1997,
      useNA="ifany")


#All with exp/out
table(final_data$bullied_bf_12_1997,final_data$ever_new_user2,
      final_data$KEY_RACE_ETHNICITY_1997,  final_data$KEY_SEX_1997,
      final_data$anySameSex, final_data$learning_disability_1997,
      final_data$MomEduDi, final_data$CV_CITIZENSHIP_1997,
      final_data$PediOverweight, final_data$YOUTH_BOTHBIO.01_1997,
      useNA="ifany")



#Steph's suggested set of variables
table(final_data$bullied_bf_12_1997,final_data$ever_new_user2,
      final_data$KEY_RACE_ETHNICITY_1997,  final_data$KEY_SEX_1997,
      final_data$MomEduDi, 
      final_data$PediOverweight, final_data$YOUTH_BOTHBIO.01_1997,
      useNA="ifany")

#same set but no PediOverweight variable 
table(final_data$bullied_bf_12_1997,final_data$ever_new_user2,
      final_data$KEY_RACE_ETHNICITY_1997,  final_data$KEY_SEX_1997,
      final_data$MomEduDi, 
      final_data$YOUTH_BOTHBIO.01_1997,
      useNA="ifany")

#Density Plots for BMI
BMIbybullyingstatus <- final_data %>% filter(bmiz> -15) %>%
                        group_by( bullied_bf_12_1997) %>% 
                        ggplot(aes(bmiz, fill = bullied_bf_12_1997)) +
                          geom_density(alpha=0.9) +
                          scale_fill_brewer(palette = 3)
BMIbybullyingstatus
ggsave("BMIbybullyingstatus.pdf", BMIbybullyingstatus)

#Boxplots for BMI
BMIbybullyingstatusBox <- final_data %>% filter(bmiz> -15) %>%
                        group_by( bullied_bf_12_1997) %>% 
                        ggplot(aes(y=bmiz, fill = bullied_bf_12_1997)) +
                          geom_boxplot() 
BMIbybullyingstatusBox
ggsave("BMIbybullyingstatusBox.pdf", BMIbybullyingstatusBox)

```

